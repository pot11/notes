# 文档

## 流程

- 业务方传变量参数和发送方式,消息中心查模板替换变量，发送第三方

## 消息模版配置

### 1.需求文档

- <https://doc.weixin.qq.com/doc/w3_AToAMgZEALgCN9aT93CXERiaFHEJF?scode=AKMAwAfUAF4hEFTX8oAToAMgZEALg>

### 2.根据消息文档配置消息中心模板配置

- 文档地址：<https://doc.weixin.qq.com/sheet/e3_AdIA2wZUAJ4CNtrSqRbSHSOmafEJc?scode=AKMAwAfUAF4WV9IoIrAdIA2wZUAJ4>
- 发送方式：

   ```json
   {
    "wxPublicChatParam": {
        "isAvailable": true,
        "wxType": "",
        "templateId": ""
    },
    "appPushParam": {
        "isAvailable": true
    },
    "appInBoxParam": {
        "isAvailable": true,
        "appInBoxType": "3"
    },
    "smsParam": {
        "isAvailable": true,
        "smsChannel": "1",
        "smsType": "1",
        "templateId": ""
    },
    "qiYeWxParam": {
        "isAvailable": true,
        "atUserList": "",
        "groupId": ""
    }
   }

   ```

- 模板内容类型：
  - 普通内容：（站内信、push、企微）
  - 短信内容：
  - 微信模板内容：

- 配置样例：

   ```json
      模版id：pt_inquiry_0000003
      标题：通话提醒
      场景：语音、视频问诊预约提前5分钟通知（点击开始咨询时，出现申请小程序订阅消息）
      短信模版：
      2.1新模版id：SMS_498325400

      普通站内信内容：
      {就诊人}有一个{医生姓名}医生的{预约服务}将会在{预约时间}开始，请提前点击进入问诊诊室等待医生发起邀请
      您好，{patientName}有一个{doctorName}医生的{reserveService}将会在{reserveTime}开始，请提前点击进入问诊诊室等待医生发起邀请

      微信模版内容:
      预约开始提醒
      就诊人{{thing2.DATA}}
      预约时间{{time3.DATA}}
      医生姓名{{thing4.DATA}}
      预约服务{{thing5.DATA}}
      备注{{thing6.DATA}}
      跳转文案点击查看详情

      短信模版：
      您好，您申请的{医生姓名}医生的{预约服务}将于{开始时间}开始，请打开“元骁健康”小程序，等待医生发起邀请。
      您好，您申请的${doctorName}医生的${reserveService}将于${reserveTime}开始，请打开“元骁健康”小程序，等待医生发起邀请。

      ai语音模版：
      您好，元贝贝互联网医院提醒您，您预约的{医生姓名}医生的视频问诊即将开始，您可以打开元骁健康小程序等待医生发起邀请。感谢您的接听，祝您早日康复

      您好，元贝贝互联网医院提醒您，您预约的${doctorName}医生的视频问诊即将开始，您可以打开元骁健康小程序等待医生发起邀请。感谢您的接听，祝您早日康复

      跳转：IM页面

      发送方式：
      {
         "smsParam": {
            "isAvailable": true,
            "smsChannel": "1",
            "smsType": "1",
            "templateId": "SMS_498325400"
         },
         "wxPublicChatParam": {
            "isAvailable": true,
            "wxType": "2",
            "templateId": "VXhxZzYV4ayRV8qCR2d2Jv_hz0J98j1sYxL7JuEy52w"
         },
         "appInBoxParam": {
            "isAvailable": true,
            "appInBoxType": "3"
         },
         "voiceCallParam": {
            "isAvailable": true,
            "templateId": "TTS_326290133"
         }
      }
      变量参数：
      [
         {
            "codeDesc": "就诊人",
            "code": "patientName",
            "wxCode": "thing2"
         },
         {
            "codeDesc": "预约时间",
            "code": "reserveTime",
            "smsCode": "reserveTime",
            "wxCode": "time3"
         },
         {
            "codeDesc": "医生姓名",
            "code": "doctorName",
            "smsCode": "doctorName",
            "voiceCode": "doctorName",
            "wxCode": "thing4"
         },
         {
            "codeDesc": "预约服务",
            "code": "reserveService",
            "smsCode": "reserveService",
            "wxCode": "thing5"
         },
         {
            "codeDesc": "备注",
            "wxCode": "thing6"
         },
         {
            "voiceCode": "minutes"
         }
      ]
   ```

- sql样例：

   ```sql
      INSERT INTO ylx_boot_dev.yl_message_center_template (id, tenant_id, template_code, template_title, template_name, scene_desc, template_content, wx_template_content, sms_template_content, voice_template_content, send_type_param, template_param, subscription_type, subscription_object, avatar, create_by, create_time, update_by, update_time, del_flag) VALUES (500, 1, 'pt_inquiry_0000003', '通话提醒', '通话提醒', '语音、视频问诊预约提前5分钟通知', '${patientName}有一个${doctorName}医生的${reserveService}将会在${reserveTime}开始，请提前点击进入问诊诊室等待医生发起邀请', '预约开始提醒
                  就诊人{{thing2.DATA}}
                  预约时间{{time3.DATA}}
                  医生姓名{{thing4.DATA}}
                  预约服务{{thing5.DATA}}
                  备注{{thing6.DATA}}
                  跳转文案点击查看详情', '您好，您申请的${doctorName}医生的${reserveService}将于${reserveTime}开始，请打开“元骁健康”小程序，等待医生发起邀请', '您好，元贝贝互联网医院提醒您，您预约的${doctorName}医生的视频问诊即将开始，您可以打开元骁健康小程序等待医生发起邀请。感谢您的接听，祝您早日康复', '{
                                                   "smsParam": {
                                                      "isAvailable": true,
                                                      "smsChannel": "1",
                                                      "smsType": "1",
                                                      "templateId": "SMS_498325400"
                                                   },
                                                   "wxPublicChatParam": {
                                                      "isAvailable": true,
                                                      "wxType": "2",
                                                      "templateId": "VXhxZzYV4ayRV8qCR2d2Jv_hz0J98j1sYxL7JuEy52w"
                                                   },
                                                   "appInBoxParam": {
                                                      "isAvailable": true,
                                                      "appInBoxType": "3"
                                                   },
                                                   "voiceCallParam": {
                                                      "isAvailable": true,
                                                      "templateId": "TTS_326290133"
                                                   }
                                                }', '[
                                    {
                                          "codeDesc": "就诊人",
                                          "code": "patientName",
                                          "wxCode": "thing2"
                                    },
                                    {
                                          "codeDesc": "预约时间",
                                          "code": "reserveTime",
                                          "smsCode": "reserveTime",
                                          "wxCode": "time3"
                                    },
                                    {
                                          "codeDesc": "医生姓名",
                                          "code": "doctorName",
                                          "smsCode": "doctorName",
                                          "voiceCode": "doctorName",
                                          "wxCode": "thing4"
                                    },
                                    {
                                          "codeDesc": "预约服务",
                                          "code": "reserveService",
                                          "smsCode": "reserveService",
                                          "wxCode": "thing5"
                                    },
                                    {
                                          "codeDesc": "备注",
                                          "wxCode": "thing6"
                                    }
                                 ]', null, null, null, 'zhengqiang', '2025-06-11 12:45:40', null, null, '0')
       ```  

## 3.代码调用

### 业务域通用入参

- 租户id  
- 业务类型
- 模版id
- 业务参数变量值
- 延迟发送时间
- 推送方式list
  - 通用参数
    - 接收人(recipent) （多人用逗号分隔拼成字符串）
      - 短信：手机号
      - 站内信：用户/医生的sysuserid
      - appPush极光推送：医生的sysuserid
      - 微信：wxopenid
      - 企微机器人：无
      - 语音：手机号

- 支持业务域传入跳转链接
- 支持业务域传入参数由消息中心生成短链，链接内容只有短信消息才会展示，中转域名由消息中心统一拼接

### 站内信

- 必传用户/医生的sysuserid。
- 有跳转链接时，要传入routeType（跳转类型）和routeLink(页面路径)（前端提供）

```java
                messageSender.send(MessageBuilder.create(patient.getTenantId(), "pt_cbti_0000001")
                        .param("thing10", "训练课程")
                        .param("const7", "免费课程")
                        .param("thing4", patient.getPatientName() )
                        .internalMsg(String.valueOf(patient.getUserId()), RouteTypeEnum.MINI_PROGRAM_TAB.getCode(), "pages/member/index")
```

### 短信

- 2.1版本开始，短信移除所有短链，只传手机号

```java
  messageSender.send(MessageBuilder.create(TenantContextHolder.getTenantId(), "all_sms_0000001")
    .param("code", code)
    .param("xxx", code)
    .sms("13173615801")
    .build());
```

### 微信

- 传参：
  - 传用户微信openid
  - 跳转小程序appid、小程序页面地址

- 服务号模板消息

```java
            messageSender.send(MessageBuilder.create(tenantId, "pt_inquiry_0000002")
                    .param("const1", "问诊")
                    .param("thing7", ptInquiryServiceOrderDetail.getPatientName())
                    .param("thing2", ptInquiryServiceOrderDetail.getPhysiciansName())
                    .param("time3", currentTime)
                    .wechatPublicTemplate(userDtoR.getData().getWxOpenid(), appId, "小程序页面地址", null)
                    .build());
```

- 小程序订阅消息

```java
                GeneralMsgDTO patientReminderMsg = MessageBuilder.create(tenantId, "pt_inquiry_0000003")
                        .param("thing2", ptInquiryServiceOrderDetail.getPatientName())
                        .param("time3", dateTimeStr)
                        .param("thing4", ptInquiryServiceOrderDetail.getPhysiciansName())
                        .param("thing5", fullInquiryType)
                        .param("thing6", "请提前点击进入问诊诊室等待医生发起邀请")
                        .wechatPublicSubscribe(userDtoR.getData().getWxOpenid(), "小程序页面地址",)
                        .build();
```

### app推送

- 传医生id
- 通知跳转地址（前端提供）

```java
            messageSender.send(MessageBuilder.create(tenantId, "模板id")
                    .internalMsg(one.getUserId().toString())
                    .push(doctorId, “页面地址”)
                    .build());
```

### 企业微信群

- 业务不传参
- 接收人、跳转链接 由消息中心模板提供

```java
                messageSender.send(MessageBuilder.create(tenantId, "模板id")
                        .param("patientName", ptInquiryServiceOrderDetail.getPatientName
                        .qiYeWx(null)
                        .build();
```

### 语音

- 手机号

```java
                messageSender.send(MessageBuilder.create(tenantId, "模板id")
                        .param("patientName", ptInquiryServiceOrderDetail.getPatientName
                        .aiVoiceCall(“13173615800)
                        .build();

```
