package com.jk.yl.pay.service.pay.impl;

import cn.hutool.core.date.DateUtil;
import cn.hutool.core.date.TimeInterval;
import cn.hutool.core.lang.Assert;
import cn.hutool.core.util.ObjectUtil;
import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.jk.yl.admin.api.util.FeignErrorUtils;
import com.jk.yl.app.api.entity.AppUser;
import com.jk.yl.app.api.feign.RemoteAppUserService;
import com.jk.yl.bs.inquiry.api.dto.PtInquiryOrderDetailDto;
import com.jk.yl.bs.inquiry.api.feign.RemotePtInquiryService;
import com.jk.yl.bs.media.api.dto.MiniProgram;
import com.jk.yl.bs.order.api.feign.RemoteOrderCenterService;
import com.jk.yl.bs.order.api.feign.RemoteOrderRefundApplyService;
import com.jk.yl.bs.order.api.response.OrderRecordResponse;
import com.jk.yl.bs.prescription.api.entity.PrescriptionWaybill;
import com.jk.yl.bs.prescription.api.feign.RemotePrescriptionWaybillService;
import com.jk.yl.bs.prescription.api.feign.RemoteUserPrescriptionService;
import com.jk.yl.common.core.constant.CommonConstants;
import com.jk.yl.common.core.constant.SecurityConstants;
import com.jk.yl.common.core.constant.enums.PayStatusEnum;
import com.jk.yl.common.core.util.OrderNumFactory;
import com.jk.yl.common.core.util.R;
import com.jk.yl.common.data.tenant.TenantContextHolder;
import com.jk.yl.common.security.util.SecurityUtils;
import com.jk.yl.message.dto.GeneralMsgDTO;
import com.jk.yl.message.dto.InternalMsgJumpParmDTO;
import com.jk.yl.message.dto.SendTypeContent;
import com.jk.yl.message.dto.WechatMsgJumpParamDTO;
import com.jk.yl.message.enums.MessageSendTypeEnum;
import com.jk.yl.message.enums.RouteTypeEnum;
import com.jk.yl.message.feign.RemoteMessageSendService;
import com.jk.yl.pay.api.constant.RefundApplyStatusEnum;
import com.jk.yl.pay.api.dto.DownLoadBillDTO;
import com.jk.yl.pay.api.dto.PayDto;
import com.jk.yl.pay.api.dto.PayOrderDto;
import com.jk.yl.pay.api.entity.MedicalInsurancePayResult;
import com.jk.yl.pay.api.entity.PayChannelConfig;
import com.jk.yl.pay.api.entity.PayMerchantChannelConfig;
import com.jk.yl.pay.api.entity.PayRequestRecord;
import com.jk.yl.pay.api.entity.PrePayOrder;
import com.jk.yl.pay.api.entity.RefundApplyOrderRecord;
import com.jk.yl.pay.api.entity.RefundRequestRecord;
import com.jk.yl.pay.constants.PayServiceNameConstants;
import com.jk.yl.pay.context.SpringContextsUtil;
import com.jk.yl.pay.enums.DicStatusEnum;
import com.jk.yl.pay.enums.OrderTypeEnum;
import com.jk.yl.pay.enums.PayChannelEnum;
import com.jk.yl.pay.enums.PayMerchantChannelStatusEnum;
import com.jk.yl.pay.enums.PayProcedureStatusEnum;
import com.jk.yl.pay.enums.RefundTypeEnum;
import com.jk.yl.pay.service.MedicalInsurancePayResultService;
import com.jk.yl.pay.service.PayChannelConfigService;
import com.jk.yl.pay.service.PayMerchantChannelConfigService;
import com.jk.yl.pay.service.PayOrderRecordService;
import com.jk.yl.pay.service.PayRequestRecordService;
import com.jk.yl.pay.service.PrePayOrderService;
import com.jk.yl.pay.service.RefundApplyOrderRecordService;
import com.jk.yl.pay.service.RefundRequestRecordService;
import com.jk.yl.pay.service.pay.IUpdateOrderStatus;
import com.jk.yl.pay.service.pay.PayGatewayService;
import com.jk.yl.pay.service.pay.PayService;
import com.jk.yl.pay.service.pay.RefundService;
import jakarta.annotation.Resource;
import jakarta.servlet.http.HttpServletRequest;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.ObjectUtils;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Set;

import static com.jk.yl.common.core.constant.CacheConstants.QUESTION_LIST_CACHE_PREFIX;
import static com.jk.yl.common.core.constant.CommonConstants.FAIL;
import static com.jk.yl.common.core.constant.CommonConstants.SUCCESS;

/**
 * @ClassName PayOrderServiceImpl
 * @Description 支付服务
 * @Author Mr.Yao
 * @Date 2021/11/20 10:48
 * @Version V1.0
 **/
@Slf4j
@Service
public class PayGatewayServiceImpl implements PayGatewayService {

    @Autowired
    private SpringContextsUtil springContextsUtil;

    @Autowired
    private PayMerchantChannelConfigService payMerchantChannelConfigService;

    @Autowired
    private PayChannelConfigService payChannelConfigService;

    @Autowired
    private PayRequestRecordService payRequestRecordService;

    @Autowired
    private RefundRequestRecordService refundRequestRecordService;

    @Autowired
    private RemotePtInquiryService remotePtInquiryService;

    @Autowired
    private PrePayOrderService prePayOrderService;

    @Autowired
    private PayOrderRecordService payOrderRecordService;

    @Autowired
    private RemoteUserPrescriptionService remoteUserPrescriptionService;

    @Autowired
    private RemotePrescriptionWaybillService remotePrescriptionWaybillService;

    @Resource
    private MedicalInsurancePayResultService medicalInsurancePayResultService;
    @Resource
    private IUpdateOrderStatus updateOrderStatus;
    @Resource
    private RefundApplyOrderRecordService refundApplyOrderRecordService;
    @Resource
    private RemoteOrderRefundApplyService remoteOrderRefundApplyService;
    @Resource
    private RemoteOrderCenterService remoteOrderCenterService;
    @Resource
    private RemoteMessageSendService remoteMessageSendService;
    @Resource
    private RemoteAppUserService remoteAppUserService;
    @Value("${wechat.miniprogram.appId}")
    private String appId;

    @Qualifier("redisTemplateJson")
    @Resource
    private RedisTemplate<String,Object> redisTemplateJson;


    /**
     * @Description: 支付网关
     * @Param: [payOrderDto, request]
     * @return: com.jk.yl.common.core.util.R
     * @Author: Mr.Yao
     * @Date: 2021/11/20 10:56
     */
    @Override
    public R jsPay(PayOrderDto payOrderDto, HttpServletRequest request) {
        log.info("支付网关 jsPay---参数:payOrderDto:{}, request:{}", payOrderDto, request);

        TimeInterval timer = DateUtil.timer();

        // 保存支付请求记录
        PayRequestRecord payRequestRecord = savePayReqRecord(payOrderDto);

        Long tenantId = payOrderDto.getTenantId();

        if (ObjectUtil.isEmpty(tenantId)) {
            return R.failed("支付失败，租户id为空！");
        }

        PayMerchantChannelConfig payMerchantChannelConfig = payMerchantChannelConfigService.getPayMerchantChannelConfigByTenantId(tenantId, payOrderDto.getChannelType());

        if (ObjectUtil.isEmpty(payMerchantChannelConfig)) {
            return R.failed("支付失败，商户无支付渠道！");
        }

        String payChannelServiceName = judgePayService(payMerchantChannelConfig);

        if (ObjectUtil.isEmpty(payChannelServiceName)) {
            return R.failed("支付失败，暂无可用支付渠道！");
        }

        // 创建预支付订单
        PrePayOrder prePayOrder = savePrePayInfo(payOrderDto, payMerchantChannelConfig.getChannelId());

        if (ObjectUtil.isEmpty(prePayOrder)) {
            return R.failed("支付失败，订单信息为空！");
        }
        //0元购直接更新业务状态为已支付
        if (payOrderDto.getPayAmount() == 0) {

            updateOrderStatus.updateOrderStatusSuccess(prePayOrder);

            return R.ok("ZERO_PAY");
        }


        PayService payService = (PayService) springContextsUtil.getBean(payChannelServiceName);

        R result = payService.jsPay(payOrderDto, request);

        // 修改支付请求记录
        updatePayReqRecord(payRequestRecord, JSON.toJSONString(result), timer.interval(), tenantId, payMerchantChannelConfig.getChannelId());

        log.info("请求支付网关耗时-----------" + timer.interval());
        return result;
    }

    /**
     * @Description: 支付网关
     * @Param: [payOrderDto, request]
     * @return: com.jk.yl.common.core.util.R
     * @Author: Mr.Yao
     * @Date: 2021/11/20 10:56
     */
    @Override
    public R appPay(PayOrderDto payOrderDto, HttpServletRequest request) {
        log.info("支付网关 appPay---参数:payOrderDto:{}, request:{}", payOrderDto, request);

        TimeInterval timer = DateUtil.timer();

        // 保存支付请求记录
        PayRequestRecord payRequestRecord = savePayReqRecord(payOrderDto);

        Long tenantId = payOrderDto.getTenantId();

        if (ObjectUtil.isEmpty(tenantId)) {
            return R.failed("支付失败，租户id为空！");
        }

        PayMerchantChannelConfig payMerchantChannelConfig = payMerchantChannelConfigService.getPayMerchantChannelConfigByTenantId(tenantId, payOrderDto.getChannelType());

        if (ObjectUtil.isEmpty(payMerchantChannelConfig)) {
            return R.failed("支付失败，商户无支付渠道！");
        }

        String payChannelServiceName = judgePayService(payMerchantChannelConfig);

        if (ObjectUtil.isEmpty(payChannelServiceName)) {
            return R.failed("支付失败，暂无可用支付渠道！");
        }

        // 创建预支付订单
        PrePayOrder prePayOrder = savePrePayInfo(payOrderDto, payMerchantChannelConfig.getChannelId());

        if (ObjectUtil.isEmpty(prePayOrder)) {
            return R.failed("支付失败，订单信息为空！");
        }

        PayService payService = (PayService) springContextsUtil.getBean(payChannelServiceName);

        R result = payService.appPay(payOrderDto, request);

        // 修改支付请求记录
        updatePayReqRecord(payRequestRecord, JSON.toJSONString(result), timer.interval(), tenantId, payMerchantChannelConfig.getChannelId());

        log.info("请求支付网关耗时-----------" + timer.interval());
        return result;
    }

    @Override
    public R queryPay(PayOrderDto payOrderDto, HttpServletRequest request) {
        log.info("支付网关 queryPay---参数:payOrderDto:{}, request:{}", payOrderDto, request);

        TimeInterval timer = DateUtil.timer();

        Long tenantId = payOrderDto.getTenantId();

        if (ObjectUtil.isEmpty(tenantId)) {
            return R.failed("查询失败，租户id为空！");
        }

        PayMerchantChannelConfig payMerchantChannelConfig = payMerchantChannelConfigService.getPayMerchantChannelConfigByTenantId(tenantId, payOrderDto.getChannelType());

        if (ObjectUtil.isEmpty(payMerchantChannelConfig)) {
            return R.failed("查询失败，    ！  ");
        }

        String payChannelServiceName = judgePayService(payMerchantChannelConfig);

        if (ObjectUtil.isEmpty(payChannelServiceName)) {
            return R.failed("查询失败，暂无可用支付渠道！");
        }

        PayService payService = (PayService) springContextsUtil.getBean(payChannelServiceName);
        PrePayOrder prePayOrder = prePayOrderService.getPrePayOrderByOrderId(payOrderDto.getOrderId());
        payOrderDto.setPayOrderId(prePayOrder.getPayOrderId());
        payOrderDto.setOrderId(prePayOrder.getOrderId());
        payOrderDto.setOrderType(prePayOrder.getOrderType());
        payOrderDto.setChannelType(prePayOrder.getChannelType());
        payOrderDto.setTenantId(prePayOrder.getTenantId());
        R result = payService.queryPay(payOrderDto, request);

        log.info("请求支付网关耗时-----------" + timer.interval());
        return result;
    }

    /**
     * @Description: 退款网关
     * @Param: [payOrderDto, request]
     * @return: com.jk.yl.common.core.util.R
     * @Author: Mr.Yao
     * @Date: 2021/11/22 15:35
     */
    @Override
    @Transactional(rollbackFor = Throwable.class)
    public R refund(PayOrderDto payOrderDto, HttpServletRequest request) {
        log.info("退款网关 refund---参数:payOrderDto:{}, request:{}", payOrderDto, request);
        TimeInterval timer = DateUtil.timer();

        // 保存退款请求记录
        RefundRequestRecord refundRequestRecord = saveRefundReqRecord(payOrderDto);
        log.info("保存退款请求记录======");

        Long tenantId = payOrderDto.getTenantId();

        if (ObjectUtil.isEmpty(tenantId) && ObjectUtil.isEmpty(SecurityUtils.getUser().getTenantId())) {
            return R.failed("退款失败，租户id为空！");
        }

        if (ObjectUtil.isEmpty(tenantId) && ObjectUtil.isNotEmpty(SecurityUtils.getUser().getTenantId())) {
            tenantId = SecurityUtils.getUser().getTenantId();
            payOrderDto.setTenantId(SecurityUtils.getUser().getTenantId());
            refundRequestRecord.setTenantId(SecurityUtils.getUser().getTenantId());
        }


        PrePayOrder prePayOrder = prePayOrderService.getPrePayOrderByOrderId(payOrderDto.getOrderId());
        log.info("prePayOrder======{}", prePayOrder);
        if (ObjectUtil.isEmpty(prePayOrder)) {
            return R.failed("退款失败，无订单支付信息！");
        }
        log.info("prePayOrder结束======{}", prePayOrder);
        RefundApplyOrderRecord refundApplyOrderRecord = refundApplyOrderRecordService.getOne(Wrappers.lambdaQuery(RefundApplyOrderRecord.class)
                .eq(RefundApplyOrderRecord::getOrderId, payOrderDto.getOrderId())
                .eq(RefundApplyOrderRecord::getDelFlag, DicStatusEnum.NO.getCode())
                .eq(!ObjectUtils.isEmpty(payOrderDto.getOrderCenterRefundId()), RefundApplyOrderRecord::getOrderCenterRefundId, payOrderDto.getOrderCenterRefundId())
        );
        log.info("refundApplyOrderRecord======{}", refundApplyOrderRecord);
        if (ObjectUtil.isNotEmpty(refundApplyOrderRecord)) {
            refundApplyOrderRecord.setRefundApplyStatus(RefundApplyStatusEnum.REFUND_ING.getCode());
            refundApplyOrderRecordService.updateStatus(refundApplyOrderRecord);
        }

        log.info("refundApplyOrderRecord结束======");
        // 零元支付
        if (prePayOrder.getPayAmount() == 0) {
            prePayOrder.setOrderCenterRefundId(payOrderDto.getOrderCenterRefundId());
            updateOrderStatus.updateOrderStatusRefund(prePayOrder, payOrderDto.getInquiryStatus(), 0);
            return R.ok("ZERO_PAY");
        }

        // 获取租户下的商户配置
        PayMerchantChannelConfig payMerchantChannelConfig = getPayMerchantChannelConfigByTenantId(prePayOrder.getTenantId(), prePayOrder.getChannelType());
        log.info("payMerchantChannelConfig======");
        if (ObjectUtil.isEmpty(payMerchantChannelConfig)) {
            return R.failed("退款失败，商户未配置退款渠道！");
        }

        // 获取支付渠道
        String payChannelServiceName = judgePayService(payMerchantChannelConfig);

        if (ObjectUtil.isEmpty(payChannelServiceName)) {
            return R.failed("退款失败，暂无可用退款渠道！");
        }

        //退款问诊 清除缓存
        R<OrderRecordResponse> orderId2 = remoteOrderCenterService.getDetailByBsOrderId(payOrderDto.getOrderId(), SecurityConstants.FROM_IN);
        if (orderId2.isOk()) {
            OrderRecordResponse data = orderId2.getData();
            // 使用通配符查找所有匹配的 key
            Set<String> keys = redisTemplateJson.keys(QUESTION_LIST_CACHE_PREFIX + data.getUserId() + "*");
            if (keys != null && !keys.isEmpty()) {
                redisTemplateJson.delete(keys);
            }
        }

        RefundService refundService = (RefundService) springContextsUtil.getBean(payChannelServiceName);
        payOrderDto.setPayAmount(prePayOrder.getPayAmount());
        payOrderDto.setChannelType(prePayOrder.getChannelType());
        payOrderDto.setChannelId(prePayOrder.getChannelId());
        payOrderDto.setTenantId(prePayOrder.getTenantId());
        payOrderDto.setOrderId(prePayOrder.getOrderId());
        payOrderDto.setPayOrderId(prePayOrder.getPayOrderId());

        // 重要！调用微信退款接口的逻辑在这里
        R result = refundService.refund(payOrderDto, request);
        // 有的退款订单没有退款申请记录
        if (ObjectUtil.isNotEmpty(refundApplyOrderRecord)) {
            if (result.isOk()) {
                refundApplyOrderRecord.setRefundApplyStatus(RefundApplyStatusEnum.REFUND_SUCCESS.getCode());
                refundApplyOrderRecordService.updateStatus(refundApplyOrderRecord);

                // 推送消息
                if ("2".equals(payOrderDto.getOrderType())){
                    R<OrderRecordResponse> centerServiceDetail = remoteOrderCenterService.getDetail(payOrderDto.getOrderCenterId(), SecurityConstants.FROM_IN);
                    FeignErrorUtils.isSuccessAndDataError(centerServiceDetail);

                    OrderRecordResponse orderRecordResponse = centerServiceDetail.getData();
                    R<AppUser> userDtoR = remoteAppUserService.infoById(orderRecordResponse.getUserId(), SecurityConstants.FROM_IN);
                    if (userDtoR.isSuccess()){
                        // 药品处方订单退款发患者
                        GeneralMsgDTO generalMsgDTO1 = new GeneralMsgDTO();
                        generalMsgDTO1.setTenantId(TenantContextHolder.getTenantId());
                        generalMsgDTO1.setTemplateCode("pt_order_0000004");
                        HashMap<String, String> messageParam1 = new HashMap<>();
                        // 站内信通知患者
                        messageParam1.put("patientName", userDtoR.getData().getName());
                        messageParam1.put("orderContent", "药品");
                        messageParam1.put("orderId", payOrderDto.getOrderId());
                        messageParam1.put("refundTime", DateUtil.format(LocalDateTime.now(), "yyyy-MM-dd HH:mm:ss"));
                        messageParam1.put("refundAmount", String.format("%.2f", payOrderDto.getRefundAmount() / 100.0));
                        messageParam1.put("refundReason", payOrderDto.getRefundReason());

                        List<SendTypeContent> sendTypeContentList2 = new ArrayList<>();
                        SendTypeContent sendTypeContent2 = new SendTypeContent();
                        sendTypeContent2.setSendTypeCode(MessageSendTypeEnum.INTERNAL_MSG.getCode());
                        sendTypeContent2.setRecipient(userDtoR.getData().getUserId().toString());
                        // 微信服务号模版消息通知患者
                        messageParam1.put("thing4", "药品");
                        messageParam1.put("character_string1", payOrderDto.getOrderId());
                        messageParam1.put("thing6", userDtoR.getData().getName().toString());
                        messageParam1.put("amount2", String.format("%.2f", payOrderDto.getRefundAmount() / 100.0));
                        messageParam1.put("time5", DateUtil.format(LocalDateTime.now(), "yyyy-MM-dd HH:mm:ss"));
                        SendTypeContent sendTypeContent3 = new SendTypeContent();
                        sendTypeContent3.setSendTypeCode(MessageSendTypeEnum.WECHAT_PUBLIC.getCode());
                        sendTypeContent3.setRecipient(userDtoR.getData().getUserId().toString());

                        sendTypeContentList2.add(sendTypeContent2);
                        sendTypeContentList2.add(sendTypeContent3);
                        generalMsgDTO1.setSendTypeContentList(sendTypeContentList2);
                        generalMsgDTO1.setParam(messageParam1);
                        remoteMessageSendService.sendMessage(generalMsgDTO1,SecurityConstants.FROM_IN);
                    }
                }else if("1".equals(payOrderDto.getOrderType())){
                   // 问诊订单退款
                    R<PtInquiryOrderDetailDto> ptInquiryServiceOrderDetailDto = remotePtInquiryService.getInquiryDetail(payOrderDto.getOrderId(), SecurityConstants.FROM_IN);
                    if (ptInquiryServiceOrderDetailDto.getCode() == SUCCESS) {
                        PtInquiryOrderDetailDto ptInquiryServiceOrderDetail = ptInquiryServiceOrderDetailDto.getData();
//                        // 问诊退款 给医生推送消息
//                        GeneralMsgDTO generalMsgDTO = new GeneralMsgDTO();
//                        generalMsgDTO.setTenantId(TenantContextHolder.getTenantId());
//                        generalMsgDTO.setTemplateCode("dc_inquiry_0000005");
//                        HashMap<String, String> messageParam = new HashMap<>();
//                        // 站内信通知医生
//                        messageParam.put("patientName", ptInquiryServiceOrderDetail.getPatientName());
//                        messageParam.put("reason", payOrderDto.getRefundReason());
//                        generalMsgDTO.setParam(messageParam);
//                        List<SendTypeContent> sendTypeContentList = new ArrayList<>();
//                        SendTypeContent sendTypeContent = new SendTypeContent();
//                        sendTypeContent.setSendTypeCode(MessageSendTypeEnum.INTERNAL_MSG.getCode());
//                        sendTypeContent.setRecipient(ptInquiryServiceOrderDetail.getPhysiciansId() + "");
//                        // 跳转问诊详情页
//                        sendTypeContent.setJumpFlag(true);
//                        InternalMsgJumpParmDTO internalMsgJumpParmDTO = new InternalMsgJumpParmDTO();
//                        internalMsgJumpParmDTO.setRouteType(RouteTypeEnum.MINI_PROGRAM_INNER.getCode());
//                        internalMsgJumpParmDTO.setRouteLink("/pages/toolbox/patient-profile?orderId=" + ptInquiryServiceOrderDetail.getOrderId());
//                        sendTypeContent.setInternalMsgJumpParmDTO(internalMsgJumpParmDTO);
//
//                        // app推送
//                        SendTypeContent sendTypeContent1 = new SendTypeContent();
//                        sendTypeContent1.setSendTypeCode(MessageSendTypeEnum.PUSH.getCode());
//                        sendTypeContent1.setRecipient(ptInquiryServiceOrderDetail.getPhysiciansId() + "");
//
//                        sendTypeContentList.add(sendTypeContent);
//                        sendTypeContentList.add(sendTypeContent1);
//                        generalMsgDTO.setSendTypeContentList(sendTypeContentList);
//                        remoteMessageSendService.sendMessage(generalMsgDTO,SecurityConstants.FROM_IN);

                        // 问诊退款 给患者推送消息
                        GeneralMsgDTO generalMsgDTO1 = new GeneralMsgDTO();
                        generalMsgDTO1.setTenantId(TenantContextHolder.getTenantId());
                        generalMsgDTO1.setTemplateCode("pt_order_0000004");
                        HashMap<String, String> messageParam1 = new HashMap<>();
                        // 站内信通知患者
                        messageParam1.put("patientName", ptInquiryServiceOrderDetail.getPatientName());
                        messageParam1.put("orderContent", ptInquiryServiceOrderDetail.getPhysiciansName() + "问诊");
                        messageParam1.put("orderId", payOrderDto.getOrderId());
                        messageParam1.put("refundTime", DateUtil.format(LocalDateTime.now(), "yyyy-MM-dd HH:mm:ss"));
                        messageParam1.put("refundAmount", String.format("%.2f", payOrderDto.getRefundAmount() / 100.0));
                        messageParam1.put("refundReason", payOrderDto.getRefundReason());

                        List<SendTypeContent> sendTypeContentList2 = new ArrayList<>();
                        SendTypeContent sendTypeContent2 = new SendTypeContent();
                        sendTypeContent2.setSendTypeCode(MessageSendTypeEnum.INTERNAL_MSG.getCode());
                        sendTypeContent2.setRecipient(ptInquiryServiceOrderDetail.getUserId().toString());
                        // 跳转问诊详情页
                        sendTypeContent2.setJumpFlag(true);
                        InternalMsgJumpParmDTO internalMsgJumpParmDTO = new InternalMsgJumpParmDTO();
                        internalMsgJumpParmDTO.setRouteType(RouteTypeEnum.MINI_PROGRAM_INNER.getCode());
                        internalMsgJumpParmDTO.setRouteLink("/pages-base/history/order-detail?orderId=" + payOrderDto.getOrderCenterId());
                        sendTypeContent2.setInternalMsgJumpParmDTO(internalMsgJumpParmDTO);
                        // 微信服务号模版消息通知患者
                        messageParam1.put("thing4", ptInquiryServiceOrderDetail.getPhysiciansName() + "问诊");
                        messageParam1.put("character_string1", payOrderDto.getOrderId());
                        messageParam1.put("thing6", ptInquiryServiceOrderDetail.getPatientName());
                        messageParam1.put("amount2", String.format("%.2f", payOrderDto.getRefundAmount() / 100.0));
                        messageParam1.put("time5", DateUtil.format(LocalDateTime.now(), "yyyy-MM-dd HH:mm:ss"));
                        SendTypeContent sendTypeContent3 = new SendTypeContent();
                        sendTypeContent3.setSendTypeCode(MessageSendTypeEnum.WECHAT_PUBLIC.getCode());
                        sendTypeContent3.setRecipient(ptInquiryServiceOrderDetail.getUserId().toString());
                        // 跳转问诊详情
                        WechatMsgJumpParamDTO wechatMsgJumpParamDTO = new WechatMsgJumpParamDTO();
                        MiniProgram miniProgram = new MiniProgram();
                        miniProgram.setPagePath("/pages-base/history/order-detail?orderId=" + payOrderDto.getOrderCenterId());
                        miniProgram.setAppid(appId);
                        wechatMsgJumpParamDTO.setMiniProgram(miniProgram);
                        sendTypeContent3.setWechatMsgJumpParamDTO(wechatMsgJumpParamDTO);

                        sendTypeContentList2.add(sendTypeContent2);
                        sendTypeContentList2.add(sendTypeContent3);
                        generalMsgDTO1.setSendTypeContentList(sendTypeContentList2);
                        generalMsgDTO1.setParam(messageParam1);
                        remoteMessageSendService.sendMessage(generalMsgDTO1,SecurityConstants.FROM_IN);
                    }
                }
            } else {
                refundApplyOrderRecord.setRefundApplyStatus(RefundApplyStatusEnum.REFUND_FAIL.getCode());
                refundApplyOrderRecordService.updateStatus(refundApplyOrderRecord);
            }
        }

        // 修改退款请求记录
        updateRefundReqRecord(refundRequestRecord, JSON.toJSONString(result), timer.interval(), tenantId, payMerchantChannelConfig.getChannelId());

        log.info("请求支付网关耗时-----------" + timer.interval());
        if (result.getCode() == 0) {
            // 修改退款申请(用户撤销、卖家确认、卖家拒绝、确认收货、拒绝收货)
            remoteOrderRefundApplyService.updateRefundOrderApply(payOrderDto.getOrderCenterRefundId(), "6", SecurityConstants.FROM_IN);
        }
        return result;
    }

    /**
     * @Description: 获取支付信息
     * @Param: [orderId, orderType, request]
     * @return: com.jk.yl.common.core.util.R
     * @Author: Mr.Yao
     * @Date: 2022/1/21 16:31
     */
    @Override
    public R getPayInfo(String orderId, Integer orderType, HttpServletRequest request) {
        QueryWrapper<PrePayOrder> wrapper = Wrappers.query();
        wrapper.eq("order_id", orderId)
                .eq("order_type", orderType)
                .eq("del_flag", DicStatusEnum.NO.getCode())
                .eq("lock_flag", DicStatusEnum.NO.getCode());
        PrePayOrder prePayOrder = prePayOrderService.getOne(wrapper);
        if (ObjectUtil.isEmpty(prePayOrder)) {
            return R.ok(prePayOrder);
        }

        LambdaQueryWrapper<MedicalInsurancePayResult> payWrapper = new LambdaQueryWrapper<>();
        payWrapper.eq(MedicalInsurancePayResult::getOrgTraceNo, prePayOrder.getPayOrderId())
                .eq(MedicalInsurancePayResult::getDelFlag, DicStatusEnum.NO.getCode())
                .eq(MedicalInsurancePayResult::getRefundStatus, 0)
                .eq(MedicalInsurancePayResult::getLockFlag, DicStatusEnum.NO.getCode());
        MedicalInsurancePayResult medicalInsurancePayResult = medicalInsurancePayResultService.getOne(payWrapper);
        if (ObjectUtil.isNotEmpty(medicalInsurancePayResult)) {
            prePayOrder.setFundPaySumamt(medicalInsurancePayResult.getFundPaySumamt());
            prePayOrder.setAcctPay(medicalInsurancePayResult.getAcctPay());
            prePayOrder.setPsnCashPay(medicalInsurancePayResult.getPsnCashPay());
        }

        return R.ok(prePayOrder);
    }

    @Override
    public R<PrePayOrder> getPayInfoByPayOrderId(String payOrderId) {
        LambdaQueryWrapper<PrePayOrder> wrapper = Wrappers.lambdaQuery();
        wrapper.eq(PrePayOrder::getPayOrderId, payOrderId)
                .eq(PrePayOrder::getDelFlag, CommonConstants.STATUS_NORMAL)
                .eq(PrePayOrder::getLockFlag, CommonConstants.STATUS_NORMAL);
        PrePayOrder prePayOrder = prePayOrderService.getOne(wrapper);
        Assert.notNull(prePayOrder, "支付订单不存在");
        LambdaQueryWrapper<MedicalInsurancePayResult> payWrapper = new LambdaQueryWrapper<>();
        payWrapper.eq(MedicalInsurancePayResult::getOrgTraceNo, prePayOrder.getPayOrderId())
                .eq(MedicalInsurancePayResult::getDelFlag, DicStatusEnum.NO.getCode())
                .eq(MedicalInsurancePayResult::getLockFlag, DicStatusEnum.NO.getCode());
        MedicalInsurancePayResult medicalInsurancePayResult = medicalInsurancePayResultService.getOne(payWrapper);
        if (ObjectUtil.isNotEmpty(medicalInsurancePayResult)) {
            prePayOrder.setFundPaySumamt(medicalInsurancePayResult.getFundPaySumamt());
            prePayOrder.setAcctPay(medicalInsurancePayResult.getAcctPay());
            prePayOrder.setPsnCashPay(medicalInsurancePayResult.getPsnCashPay());
        }
        return R.ok(prePayOrder);
    }

    /**
     * @Description: 新增或者修改发票流水号
     * @Param: [invoiceRequestId, orderId, orderType, request]
     * @return: com.jk.yl.common.core.util.R
     * @Author: Mr.Yao
     * @Date: 2022/1/21 16:35
     */
    @Override
    public R addInvoiceInfo(String invoiceRequestId, String orderId, Integer orderType, HttpServletRequest request) {
        QueryWrapper<PrePayOrder> wrapper = Wrappers.query();
        wrapper.eq("order_id", orderId)
                .eq("order_type", orderType)
                .eq("del_flag", DicStatusEnum.NO.getCode())
                .eq("lock_flag", DicStatusEnum.NO.getCode());
        PrePayOrder prePayOrder = prePayOrderService.getOne(wrapper);

        if (ObjectUtil.isEmpty(prePayOrder)) {
            return R.failed("支付信息为空！");
        }

        prePayOrder.setInvoiceRequestId(invoiceRequestId);
        prePayOrder.setUpdateTime(LocalDateTime.now());
        prePayOrderService.updateById(prePayOrder);

        return R.ok();
    }

    @Override
    public R downLoadBill(DownLoadBillDTO downLoadBillDTO) {
        log.info("下载对账单 downLoadBill---参数:downLoadBillDTO:{}", downLoadBillDTO);

        TimeInterval timer = DateUtil.timer();

        if (ObjectUtil.isEmpty(TenantContextHolder.getTenantId()) && ObjectUtil.isEmpty(SecurityUtils.getUser().getTenantId())) {
            return R.failed("下载对账单失败，租户id为空！");
        }

        PayMerchantChannelConfig payMerchantChannelConfig = getPayMerchantChannelConfigByTenantId(TenantContextHolder.getTenantId(), downLoadBillDTO.getChannelType());

        if (ObjectUtil.isEmpty(payMerchantChannelConfig)) {
            return R.failed("支付失败，商户无支付渠道！");
        }

        String payChannelServiceName = judgePayService(payMerchantChannelConfig);

        if (ObjectUtil.isEmpty(payChannelServiceName)) {
            return R.failed("下载对账单失败，暂无可用渠道！");
        }

        PayService payService = (PayService) springContextsUtil.getBean(payChannelServiceName);

        R result = payService.downLoadBill(downLoadBillDTO);

        log.info("downLoadBill 请求支付网关耗时-----------" + timer.interval());

        return result;
    }


    /**
     * @Description: 获取支付渠道
     * @Param: [data, shopper]
     * @return: java.lang.String
     * @Author: Mr.Yao
     * @Date: 2021/11/20 11:39
     */
    private String judgePayService(PayMerchantChannelConfig payMerchantChannelConfig) {

        String payChannelServiceName = "";

        PayChannelConfig payChannelConfig = payChannelConfigService.getById(payMerchantChannelConfig.getChannelId());

        if (ObjectUtil.isEmpty(payChannelConfig)) {
            return payChannelServiceName;
        }

        PayChannelEnum payChannelEnum = PayChannelEnum.getTypeByValue(payChannelConfig.getChannelType());
        switch (payChannelEnum) {
            case WECHAT_PAY:
                payChannelServiceName = PayServiceNameConstants.WECHAT_SERVICE_V2;
                break;
            // 目前没用
            case ALI_PAY:
                payChannelServiceName = PayServiceNameConstants.ALIPAY_SERVICE;
                break;
            // 目前没用
            case MEDICAL_INSURANCE:
                payChannelServiceName = PayServiceNameConstants.MEDICAL_SERVICE;
                break;
        }

        return payChannelServiceName;
    }

    /**
     * @Description: 获取租户下的商户配置
     * @Param: [tenantId]
     * @return: com.jk.yl.pay.api.entity.PayMerchantChannelConfig
     * @Author: Mr.Yao
     * @Date: 2021/11/22 9:14
     */
    private PayMerchantChannelConfig getPayMerchantChannelConfigByTenantId(Long tenantId, Integer channelType) {
        QueryWrapper<PayMerchantChannelConfig> wrapper = Wrappers.query();
        wrapper.eq("tenant_id", tenantId)
                .eq("channel_type", channelType)
                .eq("del_flag", DicStatusEnum.NO.getCode())
                .eq("lock_flag", DicStatusEnum.NO.getCode())
                .eq("status", PayMerchantChannelStatusEnum.ENABLED.getCode());
        return payMerchantChannelConfigService.getOne(wrapper);
    }

    /**
     * @Description: 保存支付请求记录
     * @Param: [payOrderDto, tenantId]
     * @return: void
     * @Author: Mr.Yao
     * @Date: 2021/11/22 9:58
     */
    private PayRequestRecord savePayReqRecord(PayOrderDto payOrderDto) {
        PayRequestRecord payRequestRecord = new PayRequestRecord();
        payRequestRecord.setOrderId(payOrderDto.getOrderId());
        payRequestRecord.setOrderType(payOrderDto.getOrderType());
        payRequestRecord.setOrderCenterId(payOrderDto.getOrderCenterId());
        payRequestRecord.setInvokeSource(payOrderDto.getInvokeSource());
        payRequestRecord.setPayType(payOrderDto.getPayType());
        payRequestRecord.setReqParameter(JSON.toJSONString(payOrderDto));
        payRequestRecord.setReqTime(LocalDateTime.now());
        payRequestRecord.setTenantId(payOrderDto.getTenantId());
        payRequestRecord.setCreateTime(LocalDateTime.now());
        payRequestRecord.setUpdateTime(LocalDateTime.now());
        payRequestRecord.setLockFlag(DicStatusEnum.NO.getCode());
        payRequestRecord.setDelFlag(DicStatusEnum.NO.getCode());
        payRequestRecord.setSystemFlag(DicStatusEnum.NO.getCode());
        payRequestRecordService.save(payRequestRecord);

        return payRequestRecord;
    }


    /**
     * @Description: 保存退款请求记录
     * @Param: [payOrderDto, channelId]
     * @return: com.jk.yl.pay.api.entity.RefundRequestRecord
     * @Author: Mr.Yao
     * @Date: 2021/11/24 15:59
     */
    private RefundRequestRecord saveRefundReqRecord(PayOrderDto payOrderDto) {
        RefundRequestRecord refundRequestRecord = new RefundRequestRecord();
        refundRequestRecord.setOrderId(payOrderDto.getOrderId());
        refundRequestRecord.setOrderType(payOrderDto.getOrderType());

        if (OrderTypeEnum.SERVICE.getCode().equals(payOrderDto.getOrderType())) {
            //问诊退款
            R<PtInquiryOrderDetailDto> inquiryDetail = remotePtInquiryService.getInquiryDetail(payOrderDto.getOrderId(), SecurityConstants.FROM_IN);
            if (ObjectUtil.isNotEmpty(inquiryDetail) && ObjectUtil.isNotEmpty(inquiryDetail.getData()) && ObjectUtil.isNotEmpty(inquiryDetail.getData().getServiceEndTime())) {
                refundRequestRecord.setIsPartRefund(DicStatusEnum.NO.getCode());
                refundRequestRecord.setIsEntry(DicStatusEnum.YES.getCode());
            } else {
                refundRequestRecord.setIsPartRefund(DicStatusEnum.NO.getCode());
                refundRequestRecord.setIsEntry(DicStatusEnum.NO.getCode());
            }

        } else if (OrderTypeEnum.PRESCRIPTION.getCode().equals(payOrderDto.getOrderType())) {
            //处方退款
            R<PrescriptionWaybill> prescriptionWaybill = remotePrescriptionWaybillService.getPrescriptionWaybillByOrderNo(payOrderDto.getOrderId(), SecurityConstants.FROM_IN);
            if (ObjectUtil.isNotEmpty(prescriptionWaybill) && ObjectUtil.isNotEmpty(prescriptionWaybill.getData()) && ObjectUtil.isNotEmpty(prescriptionWaybill.getData().getOrderShippingTime())) {
                refundRequestRecord.setIsPartRefund(DicStatusEnum.NO.getCode());
                refundRequestRecord.setIsEntry(DicStatusEnum.YES.getCode());
            } else {
                refundRequestRecord.setIsPartRefund(DicStatusEnum.NO.getCode());
                refundRequestRecord.setIsEntry(DicStatusEnum.NO.getCode());
            }
        }
        refundRequestRecord.setInvokeSource(payOrderDto.getInvokeSource());
        refundRequestRecord.setRefundType(RefundTypeEnum.ALL_REFUND.getCode());
        refundRequestRecord.setReqParameter(JSON.toJSONString(payOrderDto));
        refundRequestRecord.setReqTime(LocalDateTime.now());
        refundRequestRecord.setTenantId(payOrderDto.getTenantId());
        refundRequestRecord.setCreateTime(LocalDateTime.now());
        refundRequestRecord.setUpdateTime(LocalDateTime.now());
        refundRequestRecord.setLockFlag(DicStatusEnum.NO.getCode());
        refundRequestRecord.setDelFlag(DicStatusEnum.NO.getCode());
        refundRequestRecord.setSystemFlag(DicStatusEnum.NO.getCode());
        refundRequestRecord.setOperatorId(payOrderDto.getSysUserId());
        refundRequestRecordService.save(refundRequestRecord);

        return refundRequestRecord;
    }

    /**
     * @Description: 修改支付请求记录
     * @Param: [payOrderDto, result, payProcessTime, tenantId]
     * @return: void
     * @Author: Mr.Yao
     * @Date: 2021/11/22 10:06
     */
    private void updatePayReqRecord(PayRequestRecord payRequestRecord, String result
            , Long payProcessTime, Long tenantId, Integer channelId) {
        payRequestRecord.setRespParameter(result);
        payRequestRecord.setRespTime(LocalDateTime.now());
        payRequestRecord.setPayProcessTime(payProcessTime.intValue());
        payRequestRecord.setTenantId(tenantId);
        payRequestRecord.setUpdateTime(LocalDateTime.now());
        payRequestRecord.setChannelId(channelId);
        payRequestRecordService.updateById(payRequestRecord);
    }

    /**
     * @Description: 修改退款请求记录
     * @Param: [refundRequestRecord, result, processTime, tenantId, channelId]
     * @return: void
     * @Author: Mr.Yao
     * @Date: 2021/11/24 16:03
     */
    private void updateRefundReqRecord(RefundRequestRecord refundRequestRecord, String result
            , Long processTime, Long tenantId, Integer channelId) {
        refundRequestRecord.setRespParameter(result);
        refundRequestRecord.setRespTime(LocalDateTime.now());
        refundRequestRecord.setProcessTime(processTime.intValue());
        refundRequestRecord.setTenantId(tenantId);
        refundRequestRecord.setUpdateTime(LocalDateTime.now());
        refundRequestRecord.setChannelId(channelId);
        refundRequestRecordService.updateById(refundRequestRecord);
    }

    /**
     * @Description: 获取订单支付详情
     * @Param: [payOrderDto]
     * @return: com.jk.yl.pay.api.dto.PayDto
     * @Author: Mr.Yao
     * @Date: 2021/11/22 11:14
     */
    private PrePayOrder savePrePayInfo(PayOrderDto payOrderDto, Integer channelId) {

        return saveOrUpdatePrePayOrder(payOrderDto, channelId);
    }

    /**
     * @Description: 创建支付详情
     * @Param: [detailDto]
     * @return: com.jk.yl.pay.api.dto.PayDto
     * @Author: Mr.Yao
     * @Date: 2021/11/22 11:14
     */
    private PayDto createPayDto(PayOrderDto payOrderDto, String paySubject, String serviceCode, Integer payAmount, Integer discountedAmount, Integer originalAmount) {
        PayDto payDto = new PayDto();
        payDto.setPaySubject(paySubject);
        payDto.setOpenId(payOrderDto.getOpenId());
        payDto.setUserId(payOrderDto.getUserId());
        payDto.setServiceCode(serviceCode);
        payDto.setPayAmount(payAmount);
        payDto.setDiscountedAmount(discountedAmount);
        payDto.setOriginalAmount(originalAmount);
        return payDto;
    }

    /**
     * @Description: 保存或修改预支付订单
     * @Param: [payOrderDto, detailDto]
     * @return: void
     * @Author: Mr.Yao
     * @Date: 2021/11/22 14:32
     */
    private PrePayOrder saveOrUpdatePrePayOrder(PayOrderDto payOrderDto, Integer channelId) {
        QueryWrapper<PrePayOrder> wrapper = Wrappers.query();
        wrapper.eq("order_id", payOrderDto.getOrderId())
                .eq("del_flag", DicStatusEnum.NO.getCode())
                .eq("lock_flag", DicStatusEnum.NO.getCode());
        PrePayOrder prePayOrder = prePayOrderService.getOne(wrapper);
        String payOrderId = OrderNumFactory.getOrderCode(payOrderDto.getServiceCode(), payOrderDto.getUserId(), String.valueOf(payOrderDto.getOrderType()));

        if (ObjectUtil.isEmpty(prePayOrder)) {
            prePayOrder = new PrePayOrder();
            prePayOrder.setCreateTime(LocalDateTime.now());
        }
        prePayOrder.setPayOrderId(payOrderId);
        prePayOrder.setOrderId(payOrderDto.getOrderId());
        prePayOrder.setOrderCenterId(payOrderDto.getOrderCenterId());
        prePayOrder.setOrderType(payOrderDto.getOrderType());
        prePayOrder.setPayAmount(payOrderDto.getPayAmount());
        prePayOrder.setDiscountedAmount(payOrderDto.getDiscountedAmount());
        prePayOrder.setOriginalAmount(payOrderDto.getOriginalAmount());
        prePayOrder.setStatus(PayProcedureStatusEnum.GENERATE_ORDER.getCode());
        prePayOrder.setInvokeSource(payOrderDto.getInvokeSource());
        prePayOrder.setTenantId(payOrderDto.getTenantId());
        prePayOrder.setUpdateTime(LocalDateTime.now());
        prePayOrder.setLockFlag(DicStatusEnum.NO.getCode());
        prePayOrder.setDelFlag(DicStatusEnum.NO.getCode());
        prePayOrder.setSystemFlag(DicStatusEnum.NO.getCode());
        prePayOrder.setSubject(payOrderDto.getPaySubject());
        prePayOrder.setPayType(payOrderDto.getPayType());
        prePayOrder.setOpenId(payOrderDto.getOpenId());
        prePayOrder.setChannelId(channelId);
        prePayOrder.setChannelType(payOrderDto.getChannelType());
        prePayOrderService.saveOrUpdate(prePayOrder);
        payOrderDto.setPayOrderId(payOrderId);
        return prePayOrder;
    }
}
