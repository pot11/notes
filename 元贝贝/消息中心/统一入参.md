# 统一入参

```java
package com.jk.yl.message.dto;

import lombok.Data;

import java.util.List;
import java.util.Map;

/**
 * @author kay
 * @version 1.0.0
 * @ClassName GeneralMsgDTO
 * @Description 消息中心通用消息发送入参DTO
 * @createTime 2025年04月25日 11:15:00
 */
@Data
public class GeneralMsgDTO {

    /**
     * 租户id
     */
    private Long tenantId;

    /**
     * 模板编码
     */
    private String templateCode;

    /**
     * 业务类型（问诊、会员、处方）
     * @see com.jk.yl.message.enums.BussniessTypeEnum
     */
    private String businessType;

    /**
     * 消息来源类型（小程序、app、管理后台）
     * @see com.jk.yl.message.enums.SourceTypeEnum
     */
    private String sourceType;

    /**
     * 模板变量map映射 key:模板变量名称 value:模板变量值
     */
    private Map<String,String> param;

    /**
     *  指定发送渠道
     */
    private List<SendTypeContent> sendTypeContentList;
}

package com.jk.yl.message.dto;

import lombok.Data;

import java.util.Map;

/**
 * @author kay
 * @version 1.0.0
 * @ClassName SendTypeContent
 * @Description 发送类型入参
 * @createTime 2025年04月28日 13:49:00
 */
@Data
public class SendTypeContent {

    /**
     * 发送类型
     * @see  com.jk.yl.message.enums.MessageSendTypeEnum
     */
    private int sendTypeCode;

    /**
     * 接收人（短信：手机号 微信：openId ）
     */
    private String recipient;


    /**
     * 短信、app推送、企业微信群 跳转入参
     */
    private JumpDto jumpDto;

    /**
     * 站内信跳转入参
     */
    private InternalMsgJumpDTO internalMsgDTO;

    /**
     * 微信服务号模版消息、小程序订阅消息跳转入参
     */
    private WechatMsgJumpDTO wechatMsgDTO;

    /**
     * 扩展参数
     */
    private Map<String, String> extra;
}

package com.jk.yl.message.enums;

import cn.hutool.core.collection.CollectionUtil;
import com.jk.yl.common.core.exception.BusinessException;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import org.springframework.util.Assert;

import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

@NoArgsConstructor
@AllArgsConstructor
public enum MessageSendTypeEnum {
    INTERNAL_MSG(1), // app站内信
    SMS(2), //短信
    PUSH(3), //app推送
    WECHAT_PUBLIC(6), //微信消息
    QIYE_WX(10086);//企微机器人

    @Getter
    private int code;

    public static MessageSendTypeEnum of(Integer code) {
        Assert.notNull(code, "参数不能为空");

        List<MessageSendTypeEnum> enumList = Arrays.stream(MessageSendTypeEnum.values()).filter(x -> Objects.equals(x.getCode(), code)).collect(Collectors.toList());

        if (CollectionUtil.isEmpty(enumList)) {
            throw new BusinessException("参数异常");
        }

        if (enumList.size() > 1) {
            throw new BusinessException("枚举异常,请检查代码");
        }

        return CollectionUtil.getFirst(enumList);
    }

}

package com.jk.yl.message.dto;

import com.jk.yl.message.enums.AppRedirectsTypeEnum;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.experimental.Accessors;

import java.io.Serializable;

/**
 *  短链跳转入参
 */
@Data
@EqualsAndHashCode(callSuper = false)
@Accessors(chain = true)
public class JumpDto implements Serializable {

    private static final long serialVersionUID = 1L;

    //跳转类型(小程序-MINI_PROGRAM,客户端-APP,H5页面-H5)")
    private String JumpType;

    //微信小程序跳转所需参数
    private String query;

    //微信小程序跳转路径")
    private String path;

    //app跳转链接
    private String appLink;

    //H5跳转链接
    private String h5Link;

}

package com.jk.yl.message.dto;

import lombok.Data;

/**
 * 站内信跳转入参
 */
@Data
public class InternalMsgJumpDTO {
    /**
     * 跳转类型
     * @see com.jk.yl.message.enums.RouteTypeEnum
     */
    private String routeType;

    /**
     * 跳转链接（文章：传id）
     */
    private String routeLink;

    /**
     * 小程序appId（跳转其他小程序时必传）
     */
    private String appId;
}

package com.jk.yl.message.dto;

import com.jk.yl.bs.media.api.dto.MiniProgram;
import lombok.Data;

/**
 * 微信服务号模版消息、小程序订阅消息跳转入参
 */
@Data
public class WechatMsgJumpDTO {

    /* 服务号模版消息 ========================*/
    /**
     * 模板跳转链接
     * <pre>
     * <code>url</code>和<code>miniprogram</code>都是非必填字段，若都不传则模板无跳转；若都传，会优先跳转至小程序。
     * 开发者可根据实际需要选择其中一种跳转方式即可。当用户的微信客户端版本不支持跳小程序时，将会跳转至url。
     * </pre>
     */
    private String url;

    /**
     * 跳小程序所需数据，不需跳小程序可不用传该数据.
     */
    private MiniProgram miniProgram;



    /* 小程序订阅消息 ========================*/
    /**
     * 点击模板卡片后的跳转页面，仅限本小程序内的页面。支持带参数,（示例index?orderId=111）。该字段不填则模板无跳转
     */
    private String page;

}

@Operation(summary = "通过消息中心发送消息", description = "通过消息中心发送消息")
    @SysLog("通过消息中心发送消息")
    @PostMapping ("/sendGeneralMsg")
    @Inner(value = false)
    public R sendGeneralMsg(@RequestBody GeneralMsgDTO generalMsgDTO){
        iSendMediaMessage.sendGeneralMsg(generalMsgDTO);
        return R.ok();
    }

    @Override
    public void sendGeneralMsg(GeneralMsgDTO generalMsgDTO) {
        //根据模版code 查询内容  根据type发送消息 并保存
        String templateCode = generalMsgDTO.getTemplateCode();
        YlMessageCenterTemplate ylMessageCenterTemplate = ylMessageCenterTemplateMapper.selectOne(
                new QueryWrapper<YlMessageCenterTemplate>().lambda()
                        .eq(YlMessageCenterTemplate::getTemplateCode, templateCode)
                        .last(" limit 1 "));

        if (ObjectUtil.isNotEmpty(ylMessageCenterTemplate)) {
            //发送消息
            String availableService = ylMessageCenterTemplate.getSendTypeParam();
            YlMessageSendTypeParamDTO ylMessageSendTypeParamDTO = JSONObject.parseObject(availableService, YlMessageSendTypeParamDTO.class);
            //确定推送服务类型
            List<Integer> sendType = determineAvailableSendType(ylMessageSendTypeParamDTO, generalMsgDTO);
            List<SendTypeContent> sendTypeContentList = generalMsgDTO.getSendTypeContentList();

            // 支持的消息推送类型
            for (Integer service : sendType){
                for (SendTypeContent sendTypeContent : sendTypeContentList){
                    if (service == sendTypeContent.getSendTypeCode()){
                        switch (MessageSendTypeEnum.of(service)){
                            case INTERNAL_MSG:
                                sendInternalMsg(generalMsgDTO, ylMessageCenterTemplate,sendTypeContent);
                                break;
                            case SMS:
                                sendSms(generalMsgDTO, ylMessageCenterTemplate,sendTypeContent);
                                break;
                            case PUSH:
                                sendJPush(generalMsgDTO, ylMessageCenterTemplate,sendTypeContent);
                                break;
                            case WECHAT_PUBLIC:
                                sendWxPublicChat(generalMsgDTO, ylMessageCenterTemplate,sendTypeContent);
                                break;
                            case QIYE_WX:
                                sendQiYeWx(generalMsgDTO, ylMessageCenterTemplate,sendTypeContent);
                                break;
                            default:
                                break;
                        }
                    }
                }
            }
        }
    }

    //微信消息处理
    private void sendWxPublicChat(GeneralMsgDTO generalMsgDTO, YlMessageCenterTemplate ylMessageCenterTemplate, SendTypeContent sendTypeContent) {
        String recipient = sendTypeContent.getRecipient();
        if (ObjectUtil.isNotEmpty(recipient)){
            String[] split = recipient.split(",");
            for (String rec : split) {
                createSendRecord(generalMsgDTO, ylMessageCenterTemplate, MessageSendTypeEnum.WECHAT_PUBLIC.getCode(), rec,"");
                SystemMessageDTO systemMessageDTO = new SystemMessageDTO();
                systemMessageDTO.setTenantId(generalMsgDTO.getTenantId());
                YlMessageSendTypeParamDTO ylMessageSendTypeParamDTO = JSONObject.parseObject(ylMessageCenterTemplate.getSendTypeParam(), YlMessageSendTypeParamDTO.class);
                YlMessageSendTypeParamDTO.WxPublicChatParam wxPublicChatParam = ylMessageSendTypeParamDTO.getWxPublicChatParam();
                String templateParam = ylMessageCenterTemplate.getTemplateParam();
                JSONArray  jsonArray = JSONObject.parseArray(templateParam);
                JSONArray wxParamArray = new JSONArray();
                for (int i = 0; i < jsonArray.size(); i++) {
                    JSONObject jsonObject = jsonArray.getJSONObject(i);
                    String code = jsonObject.getString("code");
                    String wxCode = jsonObject.getString("wxCode");
                    if (ObjectUtil.isNotEmpty(code)
                            && ObjectUtil.isNotEmpty(wxCode)
                            && generalMsgDTO.getParam().containsKey(code)){
                        String value = generalMsgDTO.getParam().get(code);
                        JSONObject jsonParam = new JSONObject();
                        jsonParam.put("name",wxCode);
                        jsonParam.put("value",value);
                        wxParamArray.add(jsonParam);
                    }
                }
                if (StringUtils.equals(SendChannelEnum.WX_PUBLISH_CHAT.getChannel(), wxPublicChatParam.getWxType()) == true){
                    //发送微信公众号消息
                    PushWxPublicChatMessageDTO pushWxPublicChatMessageDTO = new PushWxPublicChatMessageDTO();
                    pushWxPublicChatMessageDTO.setTemplate_id(wxPublicChatParam.getTemplateId());
                    pushWxPublicChatMessageDTO.setTouser(rec);
                    pushWxPublicChatMessageDTO.setWxPublicMessage(wxParamArray.toJSONString());
                    //todo 路径
                    pushWxPublicChatMessageDTO.setUrl("https://www.baidu.com/");
                    MiniProgram miniProgram = new MiniProgram();
                    miniProgram.setAppid(null);
                    miniProgram.setPagePath(null);
                    miniProgram.setUsePath(false);

                    pushWxPublicChatMessageDTO.setMiniProgram(miniProgram);
                    systemMessageDTO.setPushWxPublicChatMessageDTO(pushWxPublicChatMessageDTO);
                    systemMessageDTO.setChannel(SendChannelEnum.WX_PUBLISH_CHAT.getChannel());
                }else if(StringUtils.equals(SendChannelEnum.CHAT_SUBSCRIBE.getChannel(), wxPublicChatParam.getWxType())){
                    //发送微信小程序订阅消息
                    PushChatSubscribeMessageDTO pushChatSubscribeMessageDTO = new PushChatSubscribeMessageDTO();
                    pushChatSubscribeMessageDTO.setTemplate_id(wxPublicChatParam.getTemplateId());
                    pushChatSubscribeMessageDTO.setTouser(rec);
                    pushChatSubscribeMessageDTO.setType(1);
                    //todo 路径
                    pushChatSubscribeMessageDTO.setPage(null);
                    pushChatSubscribeMessageDTO.setData(wxParamArray.toJSONString());
                    pushChatSubscribeMessageDTO.setMiniprogram_state("developer");
                    pushChatSubscribeMessageDTO.setLang("zh_CN");
                    systemMessageDTO.setPushChatSubscribeMessageDTO(pushChatSubscribeMessageDTO);
                    systemMessageDTO.setChannel(SendChannelEnum.CHAT_SUBSCRIBE.getChannel());
                }
                // 放入消息队列
                convertAndSend(QueueConstants.QUEUE_SEND_MSG,systemMessageDTO);
            }
        }

```