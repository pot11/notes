# MessageSender IM 发送接口调用说明

## 概述

`MessageSender` 是一个基于 RabbitMQ 的消息发送服务工具类，用于异步发送 IM（即时通讯）消息。所有消息都会先发送到 MQ 队列，然后由消费者异步处理并发送到腾讯云 IM。

**类路径**: `com.jk.yl.message.util.MessageSender`

**注意**: 所有方法都是异步的，调用后立即返回，消息会被发送到 MQ 队列中等待处理。

---

## 目录

- [1. 批量发送 IM 消息](#1-批量发送-im-消息)
- [2. 发送群组文本消息](#2-发送群组文本消息)
- [3. 发送群组普通消息](#3-发送群组普通消息)
- [4. 发送群组系统通知](#4-发送群组系统通知)
- [5. 发送群组卡片消息](#5-发送群组卡片消息)
- [6. 消息类型常量](#6-消息类型常量)
- [7. 卡片类型枚举](#7-卡片类型枚举)
- [8. 数据模型](#8-数据模型)
- [9. 使用示例](#9-使用示例)

---

## 1. 批量发送 IM 消息

### 方法签名

```java
public void sendIm(List<GroupSendGroupMsgDTO> messageList)
```

### 功能说明

批量发送多条 IM 消息到群组。适用于需要一次性发送多条消息的场景。

### 参数说明

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| messageList | `List<GroupSendGroupMsgDTO>` | 是 | 消息列表，可包含多条不同类型的消息 |

### 使用示例

```java
@Autowired
private MessageSender messageSender;

public void sendBatchMessages() {
    List<GroupSendGroupMsgDTO> messageList = new ArrayList<>();
    
    // 添加文本消息
    GroupSendGroupMsgDTO textMsg = GroupSendGroupMsgDTO.builder()
        .groupId("group_123")
        .fromAccount("doctor_001")
        .toAccount("patient_001")
        .orderId("order_123")
        .msgType(TencentCloudImConstant.TIM_TEXT_ELEM)
        .content("您好，这是第一条消息")
        .build();
    
    // 添加图片消息
    GroupSendGroupMsgDTO imageMsg = GroupSendGroupMsgDTO.builder()
        .groupId("group_123")
        .fromAccount("doctor_001")
        .msgType(TencentCloudImConstant.TIM_IMAGE_ELEM)
        .content("https://example.com/image.jpg")
        .build();
    
    messageList.add(textMsg);
    messageList.add(imageMsg);
    
    messageSender.sendIm(messageList);
}
```

---

## 2. 发送群组文本消息

### 方法签名

```java
public void sendImGroupTextMsg(String imGroupId, String fromAccount, String toAccount, String orderId, String textContent)
```

### 功能说明

在群组中发送普通文本消息。这是最常用的消息发送方法。

### 参数说明

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| imGroupId | `String` | 是 | IM 群组 ID |
| fromAccount | `String` | 是 | 发送方 IM 账号 ID |
| toAccount | `String` | 否 | 接收方 IM 账号 ID（可选，用于 @ 提醒） |
| orderId | `String` | 否 | 订单 ID（可选） |
| textContent | `String` | 是 | 文本消息内容 |

### 使用示例

```java
@Autowired
private MessageSender messageSender;

public void sendTextMessage() {
    messageSender.sendImGroupTextMsg(
        "group_123",           // 群组ID
        "doctor_001",          // 发送方账号
        "patient_001",         // 接收方账号（可选）
        "order_123",           // 订单ID（可选）
        "您好，请问有什么可以帮助您的吗？"  // 消息内容
    );
}
```

---

## 3. 发送群组普通消息

### 方法签名

```java
public void sendImGroupMsg(String imGroupId, String msgType, String fromAccount, String toAccount, String orderId, String content)
```

### 功能说明

在群组中发送普通消息，支持多种消息类型（文字、图片、音视频、自定义消息等）。

### 参数说明

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| imGroupId | `String` | 是 | IM 群组 ID |
| msgType | `String` | 是 | 消息类型，见[消息类型常量](#6-消息类型常量) |
| fromAccount | `String` | 是 | 发送方 IM 账号 ID |
| toAccount | `String` | 否 | 接收方 IM 账号 ID（可选） |
| orderId | `String` | 否 | 订单 ID（可选） |
| content | `String` | 是 | 消息内容（文字、URL 或自定义 JSON 字符串） |

### 消息类型说明

根据不同的 `msgType`，`content` 的格式也不同：

- **文本消息** (`TIM_TEXT_ELEM`): 直接传入文本内容
- **图片消息** (`TIM_IMAGE_ELEM`): 传入图片 URL
- **语音消息** (`TIM_SOUND_ELEM`): 传入语音文件 URL
- **视频消息** (`TIM_VIDEOFILE_ELEM`): 传入视频文件 URL
- **文件消息** (`TIM_FILE_ELEM`): 传入文件 URL
- **自定义消息** (`TIM_CUSTOM_ELEM`): 传入自定义 JSON 字符串

### 使用示例

```java
@Autowired
private MessageSender messageSender;

// 发送图片消息
public void sendImageMessage() {
    messageSender.sendImGroupMsg(
        "group_123",
        TencentCloudImConstant.TIM_IMAGE_ELEM,
        "doctor_001",
        null,
        "order_123",
        "https://example.com/image.jpg"
    );
}

// 发送语音消息
public void sendSoundMessage() {
    messageSender.sendImGroupMsg(
        "group_123",
        TencentCloudImConstant.TIM_SOUND_ELEM,
        "doctor_001",
        null,
        "order_123",
        "https://example.com/sound.mp3"
    );
}
```

---

## 4. 发送群组系统通知

### 方法签名

```java
public void sendImGroupSystemNotify(String imGroupId, String orderId, String noticeContent)
```

### 功能说明

在群组中发送系统通知消息。系统通知使用自定义消息（卡片）实现，会自动设置为 `SYSTEM` 类型的卡片消息。

### 参数说明

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| imGroupId | `String` | 是 | IM 群组 ID |
| orderId | `String` | 否 | 订单 ID（可选） |
| noticeContent | `String` | 是 | 通知内容 |

### 使用示例

```java
@Autowired
private MessageSender messageSender;

public void sendSystemNotify() {
    messageSender.sendImGroupSystemNotify(
        "group_123",           // 群组ID
        "order_123",           // 订单ID（可选）
        "系统通知：您的问诊订单已确认"  // 通知内容
    );
}
```

---

## 5. 发送群组卡片消息

### 方法签名

```java
public void sendImGroupCard(String imGroupId, String fromAccount, String orderId, ImCardDTO imCardDTO)
```

### 功能说明

在群组中发送卡片消息。卡片消息是一种富文本消息类型，可以包含标题、描述、图片、跳转链接等信息。

### 参数说明

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| imGroupId | `String` | 是 | IM 群组 ID |
| fromAccount | `String` | 是 | 发送方 IM 账号 ID |
| orderId | `String` | 否 | 订单 ID（可选） |
| imCardDTO | `ImCardDTO` | 是 | 卡片消息对象 |

### 卡片类型

支持以下卡片类型（`PushImCardEnum`）：

- `SYSTEM` - 系统消息
- `schedule_time` - 门诊时间推送
- `article_push` - 患教文章推送
- `questionnaire_push` - 问卷推送
- `questionnaire_complete` - 问卷完成
- `plan_push` - 健康计划推送
- `spec_push` - 会员服务包推送
- `inquiry_medical` - 问诊病历卡片
- `prescription` - 处方卡片消息
- `double_call` - 双呼卡片消息
- `tripartite` - 增值服务卡片消息

### 使用示例

```java
@Autowired
private MessageSender messageSender;

public void sendCardMessage() {
    // 方式1：使用 setTypeWithDefault 方法（推荐）
    ImCardDTO imCardDTO = ImCardDTO.builder().build()
        .setTypeWithDefault(
            PushImCardEnum.article_push,           // 卡片类型
            "健康科普文章",                          // 标题
            "这是一篇关于健康的科普文章",              // 描述
            "https://example.com/article.jpg",     // 图片URL（可选）
            "?articleId=123",                      // 医生端跳转参数（可选）
            "?articleId=123"                        // 患者端跳转参数（可选）
        );
    
    messageSender.sendImGroupCard(
        "group_123",
        "doctor_001",
        "order_123",
        imCardDTO
    );
}

// 方式2：发送系统通知卡片
public void sendSystemCard() {
    ImCardDTO systemCard = ImCardDTO.builder().build()
        .setTypeWithDefault(
            PushImCardEnum.SYSTEM,
            "系统通知",
            "您的订单已确认",
            null,
            null,
            null
        );
    
    messageSender.sendImGroupCard(
        "group_123",
        "system",
        "order_123",
        systemCard
    );
}
```

---

## 6. 消息类型常量

所有消息类型常量定义在 `TencentCloudImConstant` 类中：

| 常量名 | 值 | 说明 |
|--------|-----|------|
| `TIM_TEXT_ELEM` | `"TIMTextElem"` | 文本消息 |
| `TIM_IMAGE_ELEM` | `"TIMImageElem"` | 图像消息 |
| `TIM_SOUND_ELEM` | `"TIMSoundElem"` | 语音消息 |
| `TIM_VIDEOFILE_ELEM` | `"TIMVideoFileElem"` | 视频消息 |
| `TIM_FILE_ELEM` | `"TIMFileElem"` | 文件消息 |
| `TIM_CUSTOM_ELEM` | `"TIMCustomElem"` | 自定义消息（用于卡片、系统通知等） |
| `TIM_LOCATION_ELEM` | `"TIMLocationElem"` | 地理位置消息 |
| `TIM_FACE_ELEM` | `"TIMFaceElem"` | 表情消息 |

**使用方式**:

```java
import com.jk.yl.bs.media.api.constant.TencentCloudImConstant;

// 使用常量
String msgType = TencentCloudImConstant.TIM_TEXT_ELEM;
```

---

## 7. 卡片类型枚举

所有卡片类型定义在 `PushImCardEnum` 枚举中：

| 枚举值 | 说明 | 使用场景 |
|--------|------|----------|
| `SYSTEM` | 系统消息 | 系统通知、提醒消息 |
| `schedule_time` | 门诊时间推送 | 推送医生坐诊时间 |
| `article_push` | 患教文章推送 | 推送健康科普文章 |
| `questionnaire_push` | 问卷推送 | 推送问卷给患者 |
| `questionnaire_complete` | 问卷完成 | 问卷完成通知 |
| `plan_push` | 健康计划推送 | 推送健康计划 |
| `spec_push` | 会员服务包推送 | 推送会员服务包信息 |
| `inquiry_medical` | 问诊病历卡片 | 问诊病历详情卡片 |
| `prescription` | 处方卡片消息 | 处方详情卡片 |
| `double_call` | 双呼卡片消息 | 双呼通话记录卡片 |
| `tripartite` | 增值服务卡片消息 | 第三方服务卡片 |

**使用方式**:

```java
import com.jk.yl.bs.media.api.constant.PushImCardEnum;

PushImCardEnum cardType = PushImCardEnum.article_push;
```

---

## 8. 数据模型

### GroupSendGroupMsgDTO

群组消息传输对象：

```java
public class GroupSendGroupMsgDTO {
    private String fromAccount;      // 发送人 IM 账号
    private String toAccount;       // 接收人 IM 账号（可选）
    private String groupId;         // IM 群组 ID
    private String orderId;         // 问诊订单 ID（可选）
    private String msgType;         // 消息类型
    private String content;         // 消息内容
    private ImCardDTO imCard;      // 卡片消息对象（可选）
}
```

### ImCardDTO

卡片消息对象：

```java
public class ImCardDTO {
    private String env;              // 环境
    private String type;            // 卡片类型（对应 PushImCardEnum）
    private Object data;            // 卡片数据（imCardConfig 对象）
}
```

**推荐使用 `setTypeWithDefault()` 方法构建卡片对象**，该方法会根据卡片类型自动设置默认值。

---

## 9. 使用示例

### 完整示例：发送问诊相关消息

```java
import com.jk.yl.message.util.MessageSender;
import com.jk.yl.bs.media.api.constant.TencentCloudImConstant;
import com.jk.yl.bs.media.api.constant.PushImCardEnum;
import com.jk.yl.bs.media.api.dto.GroupSendGroupMsgDTO;
import com.jk.yl.bs.media.api.dto.ImCardDTO;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class InquiryMessageService {
    
    @Autowired
    private MessageSender messageSender;
    
    /**
     * 发送问诊开始消息
     */
    public void sendInquiryStartMessage(String groupId, String doctorId, String patientId, String orderId) {
        // 发送文本消息
        messageSender.sendImGroupTextMsg(
            groupId,
            doctorId,
            patientId,
            orderId,
            "您好，我是您的医生，现在开始为您进行问诊。"
        );
    }
    
    /**
     * 发送问诊病历卡片
     */
    public void sendInquiryMedicalCard(String groupId, String doctorId, String orderId) {
        ImCardDTO medicalCard = ImCardDTO.builder().build()
            .setTypeWithDefault(
                PushImCardEnum.inquiry_medical,
                "问诊病历",
                "点击查看问诊病历详情",
                null,
                "?orderId=" + orderId,
                "?orderId=" + orderId
            );
        
        messageSender.sendImGroupCard(groupId, doctorId, orderId, medicalCard);
    }
    
    /**
     * 发送处方卡片
     */
    public void sendPrescriptionCard(String groupId, String doctorId, String orderId, String prescriptionId) {
        ImCardDTO prescriptionCard = ImCardDTO.builder().build()
            .setTypeWithDefault(
                PushImCardEnum.prescription,
                "处方详情",
                "您的处方已开具，请查看详情",
                null,
                "?prescriptionId=" + prescriptionId,
                "?prescriptionId=" + prescriptionId
            );
        
        messageSender.sendImGroupCard(groupId, doctorId, orderId, prescriptionCard);
    }
    
    /**
     * 发送系统通知
     */
    public void sendOrderStatusNotify(String groupId, String orderId, String status) {
        String noticeContent = "您的问诊订单状态已更新为：" + status;
        messageSender.sendImGroupSystemNotify(groupId, orderId, noticeContent);
    }
    
    /**
     * 发送健康文章卡片
     */
    public void sendArticleCard(String groupId, String doctorId, String articleId, String title) {
        ImCardDTO articleCard = ImCardDTO.builder().build()
            .setTypeWithDefault(
                PushImCardEnum.article_push,
                title,
                "医生为您推荐了一篇健康文章",
                null,
                "?articleId=" + articleId,
                "?articleId=" + articleId
            );
        
        messageSender.sendImGroupCard(groupId, doctorId, null, articleCard);
    }
}
```

### 注意事项

1. **异步处理**: 所有消息发送都是异步的，调用方法后立即返回，消息会被放入 MQ 队列。

2. **错误处理**: 如果消息发送失败，错误信息会记录在日志中，建议在生产环境中添加异常处理和监控。

3. **参数验证**: 
   - `imGroupId` 和 `fromAccount` 是必填参数
   - `toAccount` 和 `orderId` 是可选参数，但建议在业务场景中尽量提供

4. **消息类型选择**:
   - 简单文本消息使用 `sendImGroupTextMsg()`
   - 图片、语音、视频等媒体消息使用 `sendImGroupMsg()`
   - 系统通知使用 `sendImGroupSystemNotify()`
   - 富文本卡片消息使用 `sendImGroupCard()`

5. **卡片消息构建**: 推荐使用 `ImCardDTO.setTypeWithDefault()` 方法，该方法会根据卡片类型自动设置默认的图片、跳转链接等。

---

## 10. 测试接口

项目提供了测试 Controller (`MessageSenderTestController`)，可以通过以下接口进行测试：

- `POST /test/message-sender/sendIm` - 批量发送消息
- `POST /test/message-sender/sendImGroupTextMsg` - 发送文本消息
- `POST /test/message-sender/sendImGroupMsg` - 发送普通消息
- `POST /test/message-sender/sendImGroupSystemNotify` - 发送系统通知
- `POST /test/message-sender/sendImGroupCard` - 发送卡片消息（表单参数）
- `POST /test/message-sender/sendImGroupCardJson` - 发送卡片消息（JSON）
- `GET /test/message-sender/quickTestTextMsg` - 快速测试文本消息
- `GET /test/message-sender/quickTestSystemNotify` - 快速测试系统通知

---

## 11. 相关类路径

- `MessageSender`: `com.jk.yl.message.util.MessageSender`
- `GroupSendGroupMsgDTO`: `com.jk.yl.bs.media.api.dto.GroupSendGroupMsgDTO`
- `ImCardDTO`: `com.jk.yl.bs.media.api.dto.ImCardDTO`
- `TencentCloudImConstant`: `com.jk.yl.bs.media.api.constant.TencentCloudImConstant`
- `PushImCardEnum`: `com.jk.yl.bs.media.api.constant.PushImCardEnum`

---

## 更新日志

- 2026-01-XX: 初始版本文档

---

**如有问题或建议，请联系开发团队。**
